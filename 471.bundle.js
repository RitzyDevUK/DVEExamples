"use strict";(self.webpackChunkdivinecraft=self.webpackChunkdivinecraft||[]).push([[471],{99638:(t,e,s)=>{s.d(e,{Az:()=>i.Az});var i=s(38869);s(29458)},97123:(t,e,s)=>{s.d(e,{j:()=>n});var i=s(88224),o=s(81863),r=s(54966);class n{name;index;threadPoolName;static readySet=new Set;get isRemoteReady(){return n.readySet.has(this)}get isPortSet(){return Boolean(this.port)}port=null;_pool=null;constructor(t,e,s="worker",i=null){this.name=t,this.index=e,this.threadPoolName=s,this._pool=i}setPort(t){if(this.port=t,"browser"==i.Q.environment){const e=t;e.onmessage=t=>{if(r.E.isInternal(t.data))return r.E.runInternal(t.data,this,t)},e.onmessageerror=t=>{console.error(`Error occured in from thread ${this.name}`),console.log(t.data),console.log(t)}}if("node"==i.Q.environment){const e=t;e.on("message",(t=>{if(r.E.isInternal(t))return r.E.runInternal(t,this,t)})),e.on("error",(t=>{console.error(`Error occured in from thread ${this.name}`),console.log(t)}))}this.sendMessage([r.E.INTERNAL_CODE,o.g.setReady,[this.name,this.index]])}sendMessage(t,e){if(!this.port)throw new Error(`Cannot send message to thread [${this.name}] port is not set`);this.port.postMessage(t,"browser"==i.Q.environment&&e?e:void 0)}connectToThread(t){const e=new MessageChannel;t.sendMessage([r.E.INTERNAL_CODE,o.g.connectPort,[this.name,this.threadPoolName,e.port1]],[e.port1]),this.sendMessage([r.E.INTERNAL_CODE,o.g.connectPort,[t.name,t.threadPoolName,e.port2]],[e.port2])}waitTillTaskExist(t,e=50){let s=!1;return new Promise((i=>{const o=t=>{if(s)return clearTimeout(n);t?(s=!0,i(!0),clearTimeout(n)):setTimeout(r,e)},r=()=>{this.taskExist(t,o)};let n=setTimeout(r,e)}))}taskExist(t,e){const s=r.E.getPromiseId();r.z.checkTasks[2][0]=t,r.z.checkTasks[2][1]=s,this.sendMessage(r.z.checkTasks),r.E.addPromiseTakss("tasks-check",s,(t=>{e(t)}))}runTask(t,e,s,i){const o=i?r.E.getPromiseId():-1;i&&r.E.addPromiseTakss(t,o,i),r.z.runTask[2][0]=t,r.z.runTask[2][1]=o,r.z.runTask[2][2]=e,this.sendMessage(r.z.runTask,s),r.z.runTask[2][2]=null}runTaskAsync(t,e,s){return new Promise((i=>{this.runTask(t,e,s,(t=>{i(t)}))}))}waitTillReady(){return new Promise(((t,e)=>{const s=setInterval((()=>{this.isPortSet&&(clearInterval(s),t(!0))}),1)}))}destroy(){n.readySet.delete(this),this.port&&"terminate"in this.port&&this.port.terminate()}}},50413:(t,e,s)=>{s.d(e,{p:()=>r});var i=s(97123),o=s(88224);class r{name;_totalThreads=0;_currentThread=0;__threads=[];constructor(t){this.name=t}getThreads(){return this.__threads}connectToThread(t){for(const e of this.__threads)e.connectToThread(t)}destroyAll(){for(const t of this.__threads)t.destroy()}isReady(){let t=!0;for(const e of this.__threads)e.isPortSet||(t=!1);return t}waitTillAllAreReady(){return new Promise(((t,e)=>{const s=setInterval((()=>{this.isReady()&&(clearInterval(s),t(!0))}),1)}))}addPort(t){const e=`${this.name}-${this._totalThreads}`,s=new i.j(e,this._totalThreads,this.name,this);o.Q.addThread(s),s.setPort(t),this.__threads.push(s),this._totalThreads++}runTaskForAll(t,e,s){for(let i=0;i<this.__threads.length;i++)this.__threads[i].runTask(t,e,s)}runTask(t,e,s,i,o,r){return"number"!=typeof o?(this._currentThread==r&&this.__handleCount(),this.__threads[this._currentThread].runTask(t,e,s,i),this.__handleCount()):(this.__threads[o].runTask(t,e,s,i),o)}runTaskAsync(t,e,s,i,o){return new Promise((r=>{this.runTask(t,e,s,r,i,o)}))}__handleCount(){let t=this._currentThread;return this._currentThread++,this._currentThread>=this._totalThreads&&(this._currentThread=0),t}}},74278:(t,e,s)=>{s.d(e,{Y:()=>l});var i=s(46498),o=s(25701),r=s(82683);o.QK.parent,o.QK.createThread("rich-world"),o.QK.createThread("world");class n extends r.Q{parent=o.QK.parent;world=o.QK.createThread("world");NexusComm=o.QK.createThread("nexus");DataComm=o.QK.createThread("data-loader");ConstructorComm=o.QK.createThreadPool("constructor")}class a{static environment="browser";static instance;TC=o.QK;threads=new n;constructor(t){if(a.instance)return a.instance;a.instance=this}}var h=s(23917),d=s(96715),c=s(33329);async function l(t={}){const e=new a(t||{});a.environment=h.O.isNode()?"node":"browser";let s="render";"node"==a.environment&&(s="server"),await o.QK.init("constructor",self,s);let r=!1;return(0,i.A)({onSync(t){r=!0}}),o.QK.registerTask(d.U.SyncDimension,(t=>{c._.dimensions.add(t.id)})),o.QK.registerTask(d.U.UnSyncDimension,(t=>{})),o.QK.registerTask(d.U.SyncSector,(t=>{c._.sectors.add(t[0][0],t[0][1],t[0][2],t[0][3],t[1])})),o.QK.registerTask(d.U.UnSyncSector,(t=>{c._.sectors.remove(t[0],t[1],t[2],t[3])})),await new Promise((t=>{const e=()=>{if(r)return t(!0);setTimeout(e,10)};e()})),e}},69519:(t,e,s)=>{s.d(e,{j:()=>h});var i=s(33329),o=s(28517),r=s(95027),n=s(99638),a=s(98720);class h extends a.s{_current=null;_section;voxel=new o.$(this);_voxelIndex=0;_voxelPosition=n.Az.Create();_sectorPosition=n.Az.Create();inBounds(t,e,s){const i=this._sectorPosition.x+r.k.sector.bounds.x,o=this._sectorPosition.y+r.k.sector.bounds.y,n=this._sectorPosition.z+r.k.sector.bounds.z;return!(t<this._sectorPosition.x||e<this._sectorPosition.y||s<this._sectorPosition.z||t>i||e>o||s>n)}setSector(t,e,s,o){const r=i._.sectors.get(t,e,s,o);return!!r&&(this._current=r,this._sectorPosition.x=r.position[0],this._sectorPosition.y=r.position[1],this._sectorPosition.z=r.position[2],!0)}getVoxel(t,e,s){if(!this._current)return null;const i=this._current.sections[r.k.section.getIndex(t,e,s)];if(!i){if(!i)throw new Error(`Could not load section at ${t}-${e}-${s} | ${r.k.section.getIndex(t,e,s)}`);return this._section=null,null}return this._section=i,this._voxelIndex=r.k.voxel.getIndex(t,e,s),r.k.voxel.getPosition(t,e,s,this._voxelPosition),this.voxel.loadIn(),this.voxel}}},28517:(t,e,s)=>{s.d(e,{$:()=>n});var i=s(47980),o=s(28135),r=s(17859);class n extends r.S{dataCursor;_section;get ids(){return this._section.ids}get light(){return this._section.light}get level(){return this._section.level}get state(){return this._section.state}get secondary(){return this._section.secondary}get mod(){return this._section.mod}constructor(t){super(),this.dataCursor=t}loadIn(){this.dataCursor._section&&(this._section=this.dataCursor._section,this._index=this.dataCursor._voxelIndex,this.process())}updateHeightMap(t){i.w.StateStruct.setData(this._section.sectionState);const e=this.dataCursor._voxelPosition;return 0==t?(i.w.StateStruct.setArrayPropertyValue(o.g.heightMap,e.y,1),!0):1==t&&(i.w.StateStruct.setArrayPropertyValue(o.g.dirtyMap,e.y,1),i.w.StateStruct.setArrayPropertyValue(o.g.heightMap,e.y,0),!0)}}},33329:(t,e,s)=>{s.d(e,{_:()=>u});var i=s(95027),o=s(76447),r=s(38717),n=s(99638);class a{static dimension={onNew:t=>{},onRemove:t=>{}};static sectors={onNew:(t,e)=>{},onRemove:(t,e)=>{}}}class h{static add(t){const e=o.f.CreateNew(t);return u._dimensions.set(t,e),e}static get(t){return u._dimensions.get(t)}}const d=n.Az.Create();class c{static _secotrs=[];static _enabled=!1;static getSector(){return this._enabled&&this._secotrs.length?this._secotrs.shift():r.h.CreateNew()}static returnSector(t){t.bufferView.fill(0)}}class l{static setSecotrPool(t){c._enabled=t,c._secotrs.length=0}static add(t,e,s,o,n){let a=u.dimensions.get(t);a||(a=u.dimensions.add(t)),i.k.sector.getPositionVec3Array(e,s,o,n.position);const h=new r.h(n);return a.sectors.set(i.k.hash.hashVec3Array(h.position),h),h}static new(t,e,s,i){if(this.get(t,e,s,i))return!1;let o=u.dimensions.get(t);o||(o=u.dimensions.add(t));const n=this.add(t,e,s,i,r.h.CreateNew());return a.sectors.onNew([t,e,s,i],n),!0}static get(t,e,s,o){let r=u.dimensions.get(t);return r&&r.sectors.get(i.k.hash.hashVec3(i.k.sector.getPosition(e,s,o,d)))||!1}static remove(t,e,s,o){let r=u.dimensions.get(t);if(!r)return!1;const n=i.k.sector.getPosition(e,s,o,d),h=i.k.hash.hashVec3(n),l=r.sectors.get(h);return!!l&&(c._enabled&&c.returnSector(l),a.sectors.onRemove([t,n.x,n.y,n.z],l),r.sectors.delete(h),!0)}}class u{static _dimensions=new Map;static _hooks=a;static dimensions=h;static sectors=l;static clearAll(){this._dimensions.clear()}}},95027:(t,e,s)=>{s.d(e,{k:()=>m});var i=s(71657),o=s(99638),r=s(17480);const n=o.Az.Create(),a=o.Az.Create();class h{static bounds={MinZ:-Number.MAX_SAFE_INTEGER,MaxZ:Number.MAX_SAFE_INTEGER,MinX:-Number.MAX_SAFE_INTEGER,MaxX:Number.MAX_SAFE_INTEGER,MinY:0,MaxY:256};static setWorldBounds(t,e,s,i,o,r){this.bounds.MinX=t,this.bounds.MaxX=e,this.bounds.MinX=s,this.bounds.MaxZ=i,this.bounds.MinY=o,this.bounds.MaxY=r}static inBounds(t,e,s){return!(t<this.bounds.MinX||e<this.bounds.MinY||s<this.bounds.MinZ||t>this.bounds.MaxX||e>this.bounds.MaxY||s>this.bounds.MaxZ)}static getWorldWidth(){return this.bounds.MaxX-this.bounds.MinX}static getWorldDepth(){return this.bounds.MaxZ-this.bounds.MinZ}static getWorldHeightY(){return this.bounds.MaxY-this.bounds.MinY}static getWorldDimensions(){return{width:this.getWorldWidth(),depth:this.getWorldDepth(),height:this.getWorldHeightY()}}}class d{static power2Axes=o.Az.Create();static bounds=o.Az.Create();static volumne=0;static getPosition(t,e,s,i=o.Az.Create()){return(0,r.pN)(t,e,s,d.power2Axes.x,d.power2Axes.y,d.power2Axes.z,i),i}static getPositionVec3Array(t,e,s,i=[0,0,0]){return(0,r.WS)(t,e,s,d.power2Axes.x,d.power2Axes.y,d.power2Axes.z,i),i}}class c{static power2Axes=o.Az.Create();static bounds=o.Az.Create();static volumne=0;static getPosition(t,e,s,i=o.Az.Create()){return(0,r.pN)(t,e,s,c.power2Axes.x,c.power2Axes.y,c.power2Axes.z,i),i}static getPositionVec3Array(t,e,s,i=[0,0,0]){return(0,r.WS)(t,e,s,c.bounds.x,c.bounds.y,c.bounds.z,i),i}static getIndex(t,e,s){return c.getPosition(t,e,s,n),d.getPosition(t,e,s,a),(n.y-a.y)/c.bounds.y}}class l{static bounds=o.Az.Create();static getPosition(t,e,s,i=o.Az.Create()){return(0,r.pN)(t,e,s,c.power2Axes.x,c.power2Axes.y,c.power2Axes.z,i),i.x=t-i.x,i.y=e-i.y,i.z=s-i.z,i}static getPositionVec3Array(t,e,s,i=[0,0,0]){return(0,r.WS)(t,e,s,c.power2Axes.x,c.power2Axes.y,c.power2Axes.z,i),i[0]=t-i[0],i[1]=e-i[1],i[2]=s-i[2],i}static getIndex(t,e,s){const i=this.getPosition(t,e,s,n);return(0,r.BN)(i.x,i.y,i.z,c.bounds.x,c.bounds.y,c.bounds.z)}}class u{static hashVec3(t){return`${t.x}-${t.y}-${t.z}`}static hashVec3Array(t){return`${t[0]}-${t[1]}-${t[2]}`}static hashXYZ(t,e,s){return`${t}-${e}-${s}`}}class m{static hash=u;static world=h;static sector=d;static section=c;static voxel=l}i.i.addEventListener("synced",(t=>{const{settings:e}=t.detail.settings;h.setWorldBounds(e.world.minX,e.world.maxX,e.world.minZ,e.world.maxZ,e.world.minY,e.world.maxY),d.power2Axes.x=e.sectors.sectorXPow2,d.power2Axes.y=e.sectors.sectorYPow2,d.power2Axes.z=e.sectors.sectorZPow2,d.bounds.x=1<<d.power2Axes.x,d.bounds.y=1<<d.power2Axes.y,d.bounds.z=1<<d.power2Axes.z,c.power2Axes.x=e.sections.sectionXPow2,c.power2Axes.y=e.sections.sectionYPow2,c.power2Axes.z=e.sections.sectionZPow2,c.bounds.x=1<<c.power2Axes.x,c.bounds.y=1<<c.power2Axes.y,c.bounds.z=1<<c.power2Axes.z,c.volumne=c.bounds.x*c.bounds.y*c.bounds.z,d.volumne=d.bounds.x/c.bounds.x*(d.bounds.y/c.bounds.y)*(d.bounds.z/c.bounds.z)}))},47036:(t,e,s)=>{s.d(e,{h:()=>Z});var i=s(3620);const o=i.$m.registerContext({type:"dve-nexus"});var r=s(99638);const n=i.$m.registerComponent({type:"transform",schema:i.$m.schema({position:i.$m.property(r.Az.Create(),{type:"vector-3",binary:"f32"}),rotation:i.$m.property(r.Az.Create(),{type:"vector-3",binary:"f32"}),scale:i.$m.property(r.Az.Create(1,1,1),{type:"vector-3",binary:"f32"})},[{id:"shared-array",type:"typed-array",sharedMemory:!0,arrayType:"f32"},{id:"array",type:"typed-array",arrayType:"f32"}])}),a=i.$m.registerComponent({type:"box-collider",schema:i.$m.schema({offset:i.$m.property(r.Az.Create(),{type:"vector-3",binary:"f32"}),size:i.$m.property(r.Az.Create(),{type:"vector-3",binary:"f32"})},[{id:"shared-binary-object",type:"binary-object",sharedMemory:!0},{id:"shared-binary-object",type:"binary-object"}])});class h{component;constructor(t){this.component=t}setForce(t){return r.Az.Copy(this.component.schema.force,t),t}getForce(){return this.component.schema.force}setVelocity(t){return r.Az.Copy(this.component.schema.velocity,t),t}getVelocity(){return this.component.schema.velocity}}const d=i.$m.registerComponent({type:"physics-body",data:i.$m.data(),schema:i.$m.schema({velocity:i.$m.property(r.Az.Create(),{binary:"f32"}),mass:i.$m.property(1,{binary:"f32"}),friction:i.$m.property(.5,{binary:"f32"}),acceleration:i.$m.property(r.Az.Create(),{binary:"f32"}),angularVelocity:i.$m.property(r.Az.Create(),{binary:"f32"}),angularAcceleration:i.$m.property(r.Az.Create(),{binary:"f32"}),force:i.$m.property(r.Az.Create(),{binary:"f32"}),torque:i.$m.property(r.Az.Create(),{binary:"f32"}),damping:i.$m.property(r.Az.Create(),{binary:"f32"}),angularDamping:i.$m.property(.1,{binary:"f32"}),gravityScale:i.$m.property(1,{binary:"f32"}),isKinematic:i.$m.property(0,{binary:"ui8"})},[{id:"shared-binary-object",type:"binary-object",sharedMemory:!0},{id:"binary-object",type:"binary-object"}]),init:t=>t.data=new h(t.cloneCursor()),dispose:t=>t.data.component.returnCursor()});class c{raw={hitDepth:1,nx:0,ny:0,nz:0};update(t,e,s,i){return this.raw.hitDepth=t,this.raw.nx=e,this.raw.ny=s,this.raw.nz=i,this}loadIn(t){this.raw.hitDepth=t.raw.hitDepth,this.raw.nx=t.raw.nx,this.raw.ny=t.raw.ny,this.raw.nz=t.raw.nz}reset(){this.raw.hitDepth=1,this.raw.nx=0,this.raw.ny=0,this.raw.nz=0}collided(){return this.raw.hitDepth<1}faceHit={top:()=>1==this.raw.ny&&this.collided(),bottom:()=>-1==this.raw.ny&&this.collided(),east:()=>1==this.raw.nx&&this.collided(),west:()=>-1==this.raw.nx&&this.collided(),north:()=>1==this.raw.nz&&this.collided(),south:()=>-1==this.raw.nz&&this.collided()};normalHit={x:()=>this.raw.nx,y:()=>this.raw.ny,z:()=>this.raw.nz}}class l{bounds={minX:1/0,maxX:-1/0,minZ:1/0,maxZ:-1/0,minY:1/0,maxY:-1/0};_full={w:.8,h:1.8,d:.8};_half={w:.4,h:.9,d:.4};position=r.Az.Create();constructor(t=1,e=t,s=t){this._full.w=t,this._full.h=e,this._full.d=s,this._half.w=t/2,this._half.h=e/2,this._half.d=s/2}update(t,e,s){this.width=t,this.height=e,this.depth=s}setPosition(t){r.Az.Copy(this.position,t);const e=this.position;this.bounds.minX=e.x,this.bounds.maxX=e.x+this.width,this.bounds.minZ=e.z,this.bounds.maxZ=e.z+this.depth,this.bounds.minY=e.y,this.bounds.maxY=e.y+this.height}get width(){return this._full.w}get height(){return this._full.h}get depth(){return this._full.d}set width(t){this._full.w=t,this._half.w=t/2}set height(t){this._full.h=t,this._half.h=t/2}set depth(t){this._full.d=t,this._half.d=t/2}get halfWidth(){return this._half.w}get halfHeight(){return this._half.h}get halfDepth(){return this._half.d}pointIsInside(t){return t.x>=this.bounds.minX&&t.x<=this.bounds.maxX&&t.y>=this.bounds.minY&&t.y<=this.bounds.maxY&&t.z>=this.bounds.minZ&&t.z<=this.bounds.maxZ}doesIntersect(t){return this.bounds.minX<=t.bounds.maxX&&this.bounds.maxX>=t.bounds.minX&&this.bounds.minY<=t.bounds.maxY&&this.bounds.maxY>=t.bounds.minY&&this.bounds.minZ<=t.bounds.maxZ&&this.bounds.maxZ>=t.bounds.minZ}*query(){const t=Math.floor(this.bounds.minX),e=Math.floor(this.bounds.minY),s=Math.floor(this.bounds.minZ),i=Math.ceil(this.bounds.maxX),o=Math.ceil(this.bounds.maxY),r=Math.ceil(this.bounds.maxZ);for(let n=e;n<=o;n++)for(let e=t;e<=i;e++)for(let t=s;t<=r;t++)yield[e,n,t]}}const u=i.$m.registerComponent({type:"collider-state",schema:i.$m.schema({isGrounded:i.$m.property(0,{binary:"ui8"}),isInLiquid:i.$m.property(0,{binary:"ui8"})},[{id:"shared-binary-object",type:"binary-object",sharedMemory:!0},{id:"binary-object",type:"binary-object"}])});var m=s(75025);const y={colliders:{},registerCollider(t){if(Array.isArray(t))return t.forEach((t=>this.colliders[t.id]=t));this.colliders[t.id]=t},getCollider(t){const e=this.colliders[t];if(!e)throw new Error(`Collider with ${t} does not exists.`);return e}},p=r.Az.Create(),x=r.Az.Create(),z=r.Az.Create(),g=r.Az.Create(),b=.001,w={results:new c,line:new class{start=r.Az.Create();end=r.Az.Create();update(t,e){return r.Az.Copy(this.start,t),r.Az.Copy(this.end,e),this}},plane:new class{dimensions=r.Az.Create();normal=r.Az.Create();update(t,e){return r.Az.Copy(this.dimensions,t),r.Az.Copy(this.normal,e),this}lineToPlane(t){const e=this.normal.x*t.end.x+this.normal.y*t.end.y+this.normal.z*t.end.z;return 0==e?1/0:(this.normal.x*(this.dimensions.x-t.start.x)+this.normal.y*(this.dimensions.y-t.start.y)+this.normal.z*(this.dimensions.z-t.start.z))/e}},dimensions:r.Az.Create()},f=new l,_=(t,e,s)=>t>=e&&t<=s,A={Zero:r.Az.Create(),Up:r.Az.Create(0,1,0),Down:r.Az.Create(0,-1,0),West:r.Az.Create(-1,0,0),East:r.Az.Create(1,0,0),North:r.Az.Create(0,0,1),South:r.Az.Create(0,0,-1)},C=(t,e,s,i)=>{let o,r,n,a,h,d,c;o=s.position.x-(t.x+e.width),r=s.position.y-(t.y+e.height),n=s.position.z-(t.z+e.depth),a=e.width+s.boundingBox.width,h=e.height+s.boundingBox.height,d=e.depth+s.boundingBox.depth,s.results.reset();const l=s.results.raw;return w.line.update(A.Zero,i),w.dimensions.x=o,w.dimensions.y=r,w.dimensions.z=n,c=w.plane.update(w.dimensions,A.West).lineToPlane(w.line),c>=0&&i.x>0&&c<l.hitDepth&&_(c*i.y,r,r+h)&&_(c*i.z,n,n+d)&&s.results.update(c,-1,0,0),w.dimensions.x=o+a,w.dimensions.y=r,w.dimensions.z=n,c=w.plane.update(w.dimensions,A.East).lineToPlane(w.line),c>=0&&i.x<0&&c<l.hitDepth&&_(c*i.y,r,r+h)&&_(c*i.z,n,n+d)&&s.results.update(c,1,0,0),w.dimensions.x=o,w.dimensions.y=r,w.dimensions.z=n,c=w.plane.update(w.dimensions,A.Down).lineToPlane(w.line),c>=0&&i.y>0&&c<l.hitDepth&&_(c*i.x,o,o+a)&&_(c*i.z,n,n+d)&&s.results.update(c,0,-1,0),w.dimensions.x=o,w.dimensions.y=r+h,w.dimensions.z=n,c=w.plane.update(w.dimensions,A.Up).lineToPlane(w.line),c>=0&&i.y<0&&c<l.hitDepth&&_(c*i.x,o,o+a)&&_(c*i.z,n,n+d)&&s.results.update(c,0,1,0),w.dimensions.x=o,w.dimensions.y=r,w.dimensions.z=n,c=w.plane.update(w.dimensions,A.South).lineToPlane(w.line),c>=0&&i.z>0&&c<l.hitDepth&&_(c*i.x,o,o+a)&&_(c*i.y,r,r+h)&&s.results.update(c,0,0,-1),w.dimensions.x=o,w.dimensions.y=r,w.dimensions.z=n+d,c=w.plane.update(w.dimensions,A.South).lineToPlane(w.line),c>=0&&i.z<0&&c<l.hitDepth&&_(c*i.x,o,o+a)&&_(c*i.y,r,r+h)&&s.results.update(c,0,0,1),s.results.raw};let v;r.Az.Create();const T=r.Az.Create();function P(t,e,s){if(e.isKinematic)return;e.force.y+=-9.81*e.mass*e.gravityScale;const i=e.force.x/e.mass,o=e.force.y/e.mass,r=e.force.z/e.mass;e.velocity.x+=i*s,e.velocity.y+=o*s,e.velocity.z+=r*s,e.velocity.y<-50&&(e.velocity.y=-50),e.velocity.x*=1-e.damping.x*s,e.velocity.y*=1-e.damping.y*s,e.velocity.z*=1-e.damping.z*s,T.x=-e.friction*e.velocity.x,T.y=-e.friction*e.velocity.y,T.z=-e.friction*e.velocity.z,e.velocity.x+=T.x*s,e.velocity.y+=T.y*s,e.velocity.z+=T.z*s,e.force.x=0,e.force.y=0,e.force.z=0,t.x+=e.velocity.x*s,t.y+=e.velocity.y*s,t.z+=e.velocity.z*s}function M(t,e,s){e.isKinematic&&(t.x+=e.velocity.x*s,t.y+=(e.velocity.y+-9.81*s)*s,t.z+=e.velocity.z*s)}const $=r.Az.Create(),k=i.$m.registerSystem({type:"physics",queries:[i.$m.createQuery({inclueComponents:[d]})],update(t){v||(v=new m.p);const e=t.node;for(let s=0;s<t.queries.length;s++){const i=t.queries[s];for(let s=0;s<i.nodes.length;s++){e.setNode(t.graph,i.nodes[s]);const o=n.getRequired(e).schema;r.Az.Copy(p,o.position),r.Az.Copy(g,o.position),v.setFocalPoint("main",0|p.x,0|p.y,0|p.z);const h=d.getRequired(e).schema,c=a.getRequired(e),l=u.getRequired(e).schema;f.update(c.schema.size.x,c.schema.size.y,c.schema.size.z);const m=f.halfWidth,_=f.halfDepth,A=f.halfHeight;P(p,h,.016),M(p,h,.016);let T=!1,k=!1;for(;;){x.x=p.x-g.x,x.y=p.y-g.y,x.z=p.z-g.z;const t=Math.floor(Math.min(p.x,g.x)-m),e=Math.floor(Math.max(p.x,g.x)+m),s=Math.floor(Math.min(p.y,g.y)-A),i=Math.floor(Math.max(p.y,g.y)+A),o=Math.floor(Math.min(p.z,g.z)-_),n=Math.floor(Math.max(p.z,g.z)+_);w.results.reset();let a=w.results.raw;for(let r=s;r<=i;r++)for(let s=o;s<=n;s++)for(let i=t;i<=e;i++){const t=v.getVoxel(i,r,s);if($.x=i,$.y=r,$.z=s,!t)continue;t.isRenderable()&&t.getSubstanceData().isLiquid()&&(k=!0);const e=t.getColliderStringId();if(!e)continue;const o=y.getCollider(e);if(!o)continue;const n=o.getNodes($);for(const e of n){z.x=g.x-m,z.y=g.y-A,z.z=g.z-_;const s=C(z,f,e,x);s.hitDepth<1&&1==s.ny&&(T=!0),t.checkCollisions()&&t.getSubstanceData().isSolid()&&o.isSolid&&s.hitDepth<a.hitDepth&&w.results.loadIn(e.results)}}if(p.x=g.x+a.hitDepth*x.x+b*a.nx,p.y=g.y+a.hitDepth*x.y+b*a.ny,p.z=g.z+a.hitDepth*x.z+b*a.nz,1==a.hitDepth)break;const h=a.nx*a.nx+a.ny*a.ny+a.nz*a.nz;if(0!=h){r.Az.Copy(g,p);const t=(1-a.hitDepth)*(x.x*a.nx+x.y*a.ny+x.z*a.nz);p.x+=(1-a.hitDepth)*x.x-t/h*a.nx,p.y+=(1-a.hitDepth)*x.y-t/h*a.ny,p.z+=(1-a.hitDepth)*x.z-t/h*a.nz}}r.Az.Copy(o.position,p),l.isGrounded=T?1:0,l.isInLiquid=k?1:0}}}});class S{name;boundingBox;results=new c;position=r.Az.Create();constructor(t,e){this.name=t,this.boundingBox=e}}class N{static createBBox(t=1,e=t,s=t){const i=new l(t,e,s);return i.setPosition(r.Az.Create()),i}nodes=[];addNode(t,e){this.nodes.push(new S(t,e))}hasFlag(t){return void 0!==this.flags[t]}}y.registerCollider(new class extends N{id="dve_cube";isSolid=!0;flags={};constructor(){super(),this.addNode("main",N.createBBox())}getNodes(t){return this.nodes[0].position.x=t.x,this.nodes[0].position.y=t.y,this.nodes[0].position.z=t.z,this.nodes}}),y.registerCollider(new class extends N{id="dve_climable_box";isSolid=!1;flags={dve_climbable:1};constructor(){super(),this.addNode("main",N.createBBox())}getNodes(t){return this.nodes[0].position.x=t.x,this.nodes[0].position.y=t.y,this.nodes[0].position.z=t.z,this.nodes}}),y.registerCollider(new class extends N{id="dve_stair";isSolid=!0;flags={};constructor(){super(),this.addNode("stair-bottom",N.createBBox(1,.5,1)),this.addNode("stair-top",N.createBBox(1,.5,.5))}getNodes(t){return this.nodes[0].position.x=t.x,this.nodes[0].position.y=t.y,this.nodes[0].position.z=t.z,this.nodes[0].position.x=t.x,this.nodes[1].position.y=t.y+.5,this.nodes[0].position.z=t.z,this.nodes}});const E=i.$m.registerContext({type:"dve-dimension",schema:i.$m.schemaFromObject(new class{dimension="main"})});var D;let I;i.$m.registerComponent({type:"dimension-provider",schema:i.$m.schema({dimension:i.$m.property("main")}),init(t){const e=E.get(t.node);e&&t.schema.getCursor().setProxy(t.schema.getSchemaIndex().dimension,e.schema,"dimension")}}),function(t){t.RegisterCollider="register-collider",t.RemoveCollider="remove-collider"}(D||(D={}));let X=!1;const Y=()=>{X&&(Z.graph.update(),I=setTimeout(R,16))},R=()=>Y();class Z{static graph;static async init(t){const e=i.$m.createGraph();var s;o.set(e.root,null,null,{dve:t}),this.graph=e,(s=t).TC.registerTask(D.RegisterCollider,(t=>[Z.graph.addNode(t).index])),s.TC.registerTask(D.RemoveCollider,(([t])=>{Z.graph.removeNode(t)}))}static start(){k.set(this.graph),X=!0,Y()}static stop(){k.remove(this.graph),X=!1,I&&clearTimeout(I)}}}}]);